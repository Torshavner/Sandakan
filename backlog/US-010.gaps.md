Here's the implementation summary for gap analysis:

Sandakan RAG Pipeline — Audio/Video Ingestion Implementation Summary
Architecture
Hexagonal/Clean Architecture in Rust: Domain → Application → Infrastructure → Presentation. Static dispatch via generics AppState<F: FileLoader, L: LlmClient, V: VectorStore, T: TextSplitter>. Background job processing via tokio::sync::mpsc channel (capacity 64). Single worker thread processes jobs serially.

Data Flow

Upload (multipart) → ingest_handler
  → ContentType::from_mime() validates MIME
  → Creates Job (Queued) in PostgreSQL
  → Sends IngestionMessage{job_id, document, data: Vec<u8>} via mpsc channel
  → Returns 202 Accepted {document_id, job_id}

IngestionWorker::run() consumes channel:
  → Audio|Video: MediaExtraction → Transcribing → transcription_engine.transcribe(raw_bytes)
  → PDF|Text: Processing → file_loader.extract_text()
  → text_splitter.split() → embedder.embed_batch() → vector_store.upsert()
  → Completed | Failed
Key Files
Layer	File	Purpose
Domain	src/domain/document.rs	ContentType{Pdf,Audio,Video,Text}, from_mime() matches audio/*, video/*
Domain	src/domain/job_status.rs	JobStatus{Queued,Processing,MediaExtraction,Transcribing,Embedding,Completed,Failed}
Port	src/application/ports/transcription_engine.rs	TranscriptionEngine trait + TranscriptionError enum
Service	src/application/services/ingestion_worker.rs	Background worker, pipeline branching, IngestionMessage
Service	src/application/services/ingestion_service.rs	OLD sync service — DEAD CODE, lacks transcription engine
Infra	src/infrastructure/audio/audio_decoder.rs	Symphonia decode → mono 16kHz PCM, rubato resampling
Infra	src/infrastructure/audio/candle_whisper_engine.rs	Local Whisper via candle, model in Mutex<Whisper>, 30s chunk processing
Infra	src/infrastructure/audio/openai_whisper_engine.rs	OpenAI /v1/audio/transcriptions multipart API
Infra	src/infrastructure/audio/transcription_engine_factory.rs	TranscriptionProvider{Local,OpenAi} factory
Handler	src/presentation/handlers/ingest.rs	Multipart upload → async job dispatch (202)
Handler	src/presentation/handlers/job_status.rs	GET /api/v1/jobs/{id} polling
Config	src/presentation/config/settings.rs	AudioExtractionSettings{enabled,max_file_size_mb,whisper_model,provider}, VideoExtractionSettings{enabled,max_file_size_mb}
Root	src/main.rs	Wires factory → worker → channel → AppState
Transcription Engine Selection
Config extraction.audio.provider → TranscriptionEngineFactory::create():

Local: Downloads model from HuggingFace, runs candle Whisper on CPU
OpenAI: Posts multipart to /v1/audio/transcriptions
API key reuses settings.llm.api_key (no separate whisper key)
Identified Gaps (Priority Order)
#	Severity	Gap
1	CRITICAL	extraction.*.enabled and max_file_size_mb never enforced — config is documentation-only
2	CRITICAL	No transcription timeout — long audio blocks worker indefinitely
3	HIGH	Video passes raw MP4 bytes to transcription engine — works only because Symphonia has isomp4+aac features, but untested and no fallback for containers without audio tracks
4	HIGH	IngestionService is dead code — still in AppState but never called; worker handles everything
5	HIGH	Channel send failure leaves job stuck in Queued forever (should mark Failed)
6	HIGH	No worker panic recovery — if worker dies, all uploads get 503
7	HIGH	data.to_vec() clones entire file into channel — 64 × 200MB = 12.8GB possible memory
8	MEDIUM	Empty transcript (silent audio) not handled — proceeds to embed empty string
9	MEDIUM	No MockTranscriptionEngine in tests — worker pipeline untested
10	MEDIUM	Zero integration tests for actual audio/video transcription
11	MEDIUM	OpenAI whisper hardcodes file_name("audio.wav") regardless of actual format
12	LOW	ContentType::as_mime() lossy — audio/wav → Audio → "audio/mpeg"
13	LOW	No job cleanup/TTL in PostgreSQL
14	LOW	No retry logic for failed jobs
15	LOW	Separate whisper API key config needed for mixed provider setups
Test Coverage
Covered: ContentType MIME parsing, health/query/chat handlers (mocked), job status endpoints, text sanitization, PDF extraction, embedder, PostgreSQL repos, Qdrant integration.

Not covered: Transcription engines (local + OpenAI), audio decoder, resampling, worker pipeline, video ingestion, file size enforcement, channel backpressure, worker failure recovery.

Dependencies
symphonia 0.5 (mp3, isomp4, aac, wav, pcm, ogg, flac), rubato 0.16, candle-core/nn/transformers 0.9, hf-hub 0.4, tokenizers 0.21, reqwest 0.12 (json, stream, multipart).